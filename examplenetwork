# ================================
# ğŸ”¹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
# ================================
from pulp import LpProblem, LpVariable, LpMinimize, lpSum, value
import networkx as nx
import matplotlib.pyplot as plt

# ================================
# 1ï¸âƒ£ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ================================
suppliers = ['S1', 'S2']
plants = ['P1', 'P2']
markets = ['M1', 'M2']

# Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
supply = {'S1': 60, 'S2': 40}

# Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ù…ØµØ§Ù†Ø¹
capacity = {'P1': 70, 'P2': 50}

# Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚
demand = {'M1': 50, 'M2': 60}

# ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ù…ØµØ§Ù†Ø¹
cost_sp = {
    ('S1', 'P1'): 4, ('S1', 'P2'): 6,
    ('S2', 'P1'): 5, ('S2', 'P2'): 4
}

# ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…ØµØ§Ù†Ø¹ ÙˆØ§Ù„Ø£Ø³ÙˆØ§Ù‚
cost_pm = {
    ('P1', 'M1'): 3, ('P1', 'M2'): 5,
    ('P2', 'M1'): 6, ('P2', 'M2'): 4
}

# ================================
# 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø®Ø·ÙŠØ©
# ================================
model = LpProblem("3_Level_Logistics_Network", LpMinimize)

# ================================
# 3ï¸âƒ£ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (ØªØ¯ÙÙ‚Ø§Øª Ø§Ù„Ù†Ù‚Ù„)
# ================================
x_sp = LpVariable.dicts("Ship_SP", (suppliers, plants), lowBound=0)
x_pm = LpVariable.dicts("Ship_PM", (plants, markets), lowBound=0)

# ================================
# 4ï¸âƒ£ Ø¯Ø§Ù„Ø© Ø§Ù„Ù‡Ø¯Ù: ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
# ================================
model += (
    lpSum(cost_sp[(s, p)] * x_sp[s][p] for s in suppliers for p in plants) +
    lpSum(cost_pm[(p, m)] * x_pm[p][m] for p in plants for m in markets)
)

# ================================
# 5ï¸âƒ£ Ø§Ù„Ù‚ÙŠÙˆØ¯
# ================================

# Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
for s in suppliers:
    model += lpSum(x_sp[s][p] for p in plants) <= supply[s]

# Ù‚ÙŠÙˆØ¯ Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ù…ØµØ§Ù†Ø¹ ÙˆØ§Ù„ØªÙˆØ§Ø²Ù† (Ø§Ù„ÙˆØ§Ø±Ø¯ = Ø§Ù„ØµØ§Ø¯Ø±)
for p in plants:
    model += (
        lpSum(x_sp[s][p] for s in suppliers)
        == lpSum(x_pm[p][m] for m in markets)
    )
    model += lpSum(x_sp[s][p] for s in suppliers) <= capacity[p]

# Ù‚ÙŠÙˆØ¯ ØªÙ„Ø¨ÙŠØ© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚
for m in markets:
    model += lpSum(x_pm[p][m] for p in plants) >= demand[m]

# ================================
# 6ï¸âƒ£ Ø­Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
# ================================
model.solve()

# ================================
# 7ï¸âƒ£ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
# ================================
print("ğŸ”¹ Ø§Ù„Ù†Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ù†Ø¹:")
for s in suppliers:
    for p in plants:
        if x_sp[s][p].value() > 0:
            print(f"{s} â†’ {p} : {x_sp[s][p].value()} ÙˆØ­Ø¯Ø© (ØªÙƒÙ„ÙØ© {cost_sp[(s,p)]})")

print("\nğŸ”¹ Ø§Ù„Ù†Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØµØ§Ù†Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚:")
for p in plants:
    for m in markets:
        if x_pm[p][m].value() > 0:
            print(f"{p} â†’ {m} : {x_pm[p][m].value()} ÙˆØ­Ø¯Ø© (ØªÙƒÙ„ÙØ© {cost_pm[(p,m)]})")

print(f"\nğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø«Ù„Ù‰: {value(model.objective)}")

# ================================
# 8ï¸âƒ£ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø´Ø¨ÙƒØ©
# ================================
G = nx.DiGraph()

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‚Ø¯ (nodes)
for s in suppliers:
    G.add_node(s, pos=(0, suppliers.index(s)))

for p in plants:
    G.add_node(p, pos=(1, plants.index(p)))

for m in markets:
    G.add_node(m, pos=(2, markets.index(m)))

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ (edges)
for s in suppliers:
    for p in plants:
        if x_sp[s][p].value() > 0:
            G.add_edge(s, p, weight=cost_sp[(s, p)], flow=x_sp[s][p].value())

for p in plants:
    for m in markets:
        if x_pm[p][m].value() > 0:
            G.add_edge(p, m, weight=cost_pm[(p, m)], flow=x_pm[p][m].value())

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„Ø±Ø³Ù…
pos = {
    s: (0, suppliers.index(s) * 2)
    for s in suppliers
}
pos.update({
    p: (2, plants.index(p) * 2)
    for p in plants
})
pos.update({
    m: (4, markets.index(m) * 2)
    for m in markets
})

# Ø±Ø³Ù… Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·
plt.figure(figsize=(10, 6))
nx.draw(G, pos, with_labels=True, node_size=1800, node_color="skyblue", arrows=True)

# ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù
edge_labels = {
    (u, v): f"{d['flow']}u | c={d['weight']}"
    for u, v, d in G.edges(data=True)
}
nx.draw_networkx_edge_labels(G, pos, edge_labels=edge_labels, font_size=10)

plt.title("Ø´Ø¨ÙƒØ© Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠÙƒ Ø§Ù„Ù…Ø«Ù„Ù‰ (3 Ù…Ø³ØªÙˆÙŠØ§Øª)")
plt.axis("off")
plt.show()
